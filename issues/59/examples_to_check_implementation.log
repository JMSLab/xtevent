
. 
. ****************** issue 59: examples to check implementation *******************
. 
. *directory where to save plots
. global plots "C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation"

. *install the xtevent version from the branch
. *net install xtevent, from("https://raw.githubusercontent.com/JMSLab/xtevent/issue_59-allow-for-data-structures-t
> hat-cannot-be-xtseted") replace
. 
. *load the small version of the repeated cross-sectional dataset example31
. use "https://github.com/JMSLab/xtevent/blob/issue_59-allow-for-data-structures-that-cannot-be-xtseted/issues/59/s
> mall_repeated_cross_sectional_example31.dta?raw=true", clear

. 
. ************** test correct implementation of 1st appraoch ****************
. 
. ****** _eventols
. 
. xtset, clear

. *add missing values to policyvar 
. replace z=. if state==1 & t==12 
(19 real changes made, 19 to missing)

. replace z=. in 1
(1 real change made, 1 to missing)

. 
. * default  
. cap drop aa*

. xtevent y, panelvar(state) t(t) policyvar(z) window(5) repeatedcs savek(aa)

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

No proxy or instruments provided. Implementing OLS estimator
Policyvar has missing values within some (state, t) cells. These observations will be ignored.

Linear regression, absorbing indicators         Number of obs     =      8,876
Absorbed variable: state                        No. of categories =         45
                                                F(  20,   8811)   =      81.14
                                                Prob > F          =     0.0000
                                                R-squared         =     0.3168
                                                Adj R-squared     =     0.3118
                                                Root MSE          =     1.5339

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.7759556   .1856253    -4.18   0.000    -1.139825   -.4120867
    _k_eq_m5 |  -.4067207   .2051897    -1.98   0.047    -.8089405    -.004501
    _k_eq_m4 |  -.3028598   .1863973    -1.62   0.104    -.6682421    .0625224
    _k_eq_m3 |  -.0241145   .1931065    -0.12   0.901    -.4026483    .3544193
    _k_eq_m2 |  -.1008316   .1814005    -0.56   0.578    -.4564188    .2547556
    _k_eq_p0 |   1.452096    .173224     8.38   0.000     1.112536    1.791655
    _k_eq_p1 |   1.586318   .1767118     8.98   0.000     1.239921    1.932714
    _k_eq_p2 |   1.479295   .1707863     8.66   0.000     1.144514    1.814076
    _k_eq_p3 |   1.479473   .1846419     8.01   0.000     1.117532    1.841414
    _k_eq_p4 |   1.613104   .1937528     8.33   0.000     1.233304    1.992905
    _k_eq_p5 |   1.568444   .2084751     7.52   0.000     1.159784    1.977104
    _k_eq_p6 |   1.674485   .1901398     8.81   0.000     1.301767    2.047204
             |
           t |
          8  |   .0832278   .0686065     1.21   0.225     -.051257    .2177127
          9  |   .4200314   .0695781     6.04   0.000     .2836421    .5564207
         10  |   .5419583   .0707438     7.66   0.000     .4032839    .6806327
         11  |   .7206891   .0701513    10.27   0.000     .5831763     .858202
         12  |   .9501905   .0715509    13.28   0.000      .809934    1.090447
         13  |   1.070299   .0734017    14.58   0.000     .9264148    1.214184
         14  |   1.283497   .0743598    17.26   0.000     1.137735     1.42926
         15  |   1.559122   .0753249    20.70   0.000     1.411468    1.706776
             |
       _cons |   1.987961   .1758141    11.31   0.000     1.643324    2.332597
------------------------------------------------------------------------------
F test of absorbed indicators: F(44, 8811) = 1.487            Prob > F = 0.020

. 
. * trend 
. cap drop aa*

. xtevent y, panelvar(state) t(t) policyvar(z) window(5) trend(-3, method(ols)) repeatedcs savek(aa)

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

No proxy or instruments provided. Implementing OLS estimator
Policyvar has missing values within some (state, t) cells. These observations will be ignored.

Linear regression, absorbing indicators         Number of obs     =      8,913
Absorbed variable: state                        No. of categories =         46
                                                F(  19,   8848)   =      85.29
                                                Prob > F          =     0.0000
                                                R-squared         =     0.3159
                                                Adj R-squared     =     0.3110
                                                Root MSE          =     1.5339

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.7982296    .248654    -3.21   0.001    -1.285649     -.31081
    _k_eq_m5 |  -.2028059    .325405    -0.62   0.533    -.8406753    .4350635
    _k_eq_m4 |  -.0932995   .2318272    -0.40   0.687    -.5477347    .3611357
    _k_eq_p0 |   1.424125   .2275554     6.26   0.000     .9780633    1.870186
    _k_eq_p1 |   1.511811   .3077545     4.91   0.000      .908541    2.115082
    _k_eq_p2 |   1.358867   .3895197     3.49   0.000     .5953175    2.122416
    _k_eq_p3 |   1.313237   .4829411     2.72   0.007     .3665604    2.259914
    _k_eq_p4 |   1.400966   .5745002     2.44   0.015     .2748127     2.52712
    _k_eq_p5 |   1.311759   .6686365     1.96   0.050     .0010759    2.622441
    _k_eq_p6 |    1.64466   .2372966     6.93   0.000     1.179504    2.109817
             |
           t |
          8  |    .082935   .0686014     1.21   0.227    -.0515398    .2174097
          9  |   .4204031   .0695735     6.04   0.000     .2840229    .5567833
         10  |   .5510561   .0705481     7.81   0.000     .4127655    .6893466
         11  |   .7119559   .0699895    10.17   0.000     .5747602    .8491515
         12  |   .9511373   .0715322    13.30   0.000     .8109176    1.091357
         13  |    1.07091   .0733788    14.59   0.000     .9270705    1.214749
         14  |   1.284362   .0743545    17.27   0.000      1.13861    1.430115
         15  |   1.559775     .07532    20.71   0.000      1.41213     1.70742
             |
     _ttrend |   .0455112   .0948932     0.48   0.632    -.1405016     .231524
       _cons |   2.012341   .2400487     8.38   0.000      1.54179    2.482893
------------------------------------------------------------------------------
F test of absorbed indicators: F(45, 8848) = 1.447            Prob > F = 0.027

. 
. * trend & impute 
. cap drop aa*

. xtevent y, panelvar(state) t(t) policyvar(z) window(5) trend(-3, method(ols)) impute(instag) repeatedcs savek(aa)

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =     19,999
Absorbed variable: state                        No. of categories =         46
                                                F(  30,  19923)   =     501.76
                                                Prob > F          =     0.0000
                                                R-squared         =     0.4892
                                                Adj R-squared     =     0.4872
                                                Root MSE          =     1.5321

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.9582053   .1506132    -6.36   0.000     -1.25342   -.6629909
    _k_eq_m5 |   .0629817   .2266945     0.28   0.781    -.3813584    .5073218
    _k_eq_m4 |   .0203175   .1677201     0.12   0.904    -.3084279     .349063
    _k_eq_p0 |   1.354563   .1691521     8.01   0.000     1.023011    1.686115
    _k_eq_p1 |   1.309085   .2265435     5.78   0.000     .8650411    1.753129
    _k_eq_p2 |   1.052848   .2851777     3.69   0.000      .493876     1.61182
    _k_eq_p3 |   .8610898   .3488792     2.47   0.014     .1772577    1.544922
    _k_eq_p4 |   .7594306    .416036     1.83   0.068    -.0560346    1.574896
    _k_eq_p5 |    .736683   .4791443     1.54   0.124    -.2024795    1.675846
    _k_eq_p6 |    1.48062   .1536509     9.64   0.000     1.179451    1.781788
             |
           t |
          2  |   .1621687   .0685769     2.36   0.018     .0277521    .2965852
          3  |    .348804   .0687381     5.07   0.000     .2140715    .4835364
          4  |   .4730612   .0697862     6.78   0.000     .3362745     .609848
          5  |   .6984496   .0693121    10.08   0.000      .562592    .8343071
          6  |   .8798963   .0695706    12.65   0.000     .7435322     1.01626
          7  |   .9901627   .0695565    14.24   0.000     .8538262    1.126499
          8  |   1.068714   .0682408    15.66   0.000     .9349565    1.202472
          9  |   1.402708   .0690674    20.31   0.000      1.26733    1.538086
         10  |   1.523742   .0700246    21.76   0.000     1.386488    1.660996
         11  |   1.682076   .0689303    24.40   0.000     1.546967    1.817185
         12  |   1.916719   .0697368    27.49   0.000     1.780029    2.053409
         13  |   2.042803   .0708162    28.85   0.000     1.903997    2.181608
         14  |   2.262457   .0710625    31.84   0.000     2.123169    2.401745
         15  |   2.527797    .071058    35.57   0.000     2.388518    2.667077
         16  |   2.603956   .0700397    37.18   0.000     2.466672    2.741239
         17  |   2.767944   .0706484    39.18   0.000     2.629467    2.906421
         18  |   2.984791   .0715287    41.73   0.000     2.844589    3.124993
         19  |    3.22536    .071473    45.13   0.000     3.085267    3.365453
         20  |   3.333671   .0716245    46.54   0.000     3.193281    3.474061
             |
     _ttrend |   .1456534   .0662627     2.20   0.028     .0157731    .2755337
       _cons |   1.206346   .1580256     7.63   0.000     .8966031     1.51609
------------------------------------------------------------------------------
F test of absorbed indicators: F(45, 19923) = 2.614           Prob > F = 0.000

. 
. * trend & impute, saveimp
. cap drop aa*

. cap drop *imputed

. xtevent y, panelvar(state) t(t) policyvar(z) window(5) trend(-3, method(ols)) impute(instag, saveimp) savek(aa) r
> epeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =     19,999
Absorbed variable: state                        No. of categories =         46
                                                F(  30,  19923)   =     501.76
                                                Prob > F          =     0.0000
                                                R-squared         =     0.4892
                                                Adj R-squared     =     0.4872
                                                Root MSE          =     1.5321

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.9582053   .1506132    -6.36   0.000     -1.25342   -.6629909
    _k_eq_m5 |   .0629817   .2266945     0.28   0.781    -.3813584    .5073218
    _k_eq_m4 |   .0203175   .1677201     0.12   0.904    -.3084279     .349063
    _k_eq_p0 |   1.354563   .1691521     8.01   0.000     1.023011    1.686115
    _k_eq_p1 |   1.309085   .2265435     5.78   0.000     .8650411    1.753129
    _k_eq_p2 |   1.052848   .2851777     3.69   0.000      .493876     1.61182
    _k_eq_p3 |   .8610898   .3488792     2.47   0.014     .1772577    1.544922
    _k_eq_p4 |   .7594306    .416036     1.83   0.068    -.0560346    1.574896
    _k_eq_p5 |    .736683   .4791443     1.54   0.124    -.2024795    1.675846
    _k_eq_p6 |    1.48062   .1536509     9.64   0.000     1.179451    1.781788
             |
           t |
          2  |   .1621687   .0685769     2.36   0.018     .0277521    .2965852
          3  |    .348804   .0687381     5.07   0.000     .2140715    .4835364
          4  |   .4730612   .0697862     6.78   0.000     .3362745     .609848
          5  |   .6984496   .0693121    10.08   0.000      .562592    .8343071
          6  |   .8798963   .0695706    12.65   0.000     .7435322     1.01626
          7  |   .9901627   .0695565    14.24   0.000     .8538262    1.126499
          8  |   1.068714   .0682408    15.66   0.000     .9349565    1.202472
          9  |   1.402708   .0690674    20.31   0.000      1.26733    1.538086
         10  |   1.523742   .0700246    21.76   0.000     1.386488    1.660996
         11  |   1.682076   .0689303    24.40   0.000     1.546967    1.817185
         12  |   1.916719   .0697368    27.49   0.000     1.780029    2.053409
         13  |   2.042803   .0708162    28.85   0.000     1.903997    2.181608
         14  |   2.262457   .0710625    31.84   0.000     2.123169    2.401745
         15  |   2.527797    .071058    35.57   0.000     2.388518    2.667077
         16  |   2.603956   .0700397    37.18   0.000     2.466672    2.741239
         17  |   2.767944   .0706484    39.18   0.000     2.629467    2.906421
         18  |   2.984791   .0715287    41.73   0.000     2.844589    3.124993
         19  |    3.22536    .071473    45.13   0.000     3.085267    3.365453
         20  |   3.333671   .0716245    46.54   0.000     3.193281    3.474061
             |
     _ttrend |   .1456534   .0662627     2.20   0.028     .0157731    .2755337
       _cons |   1.206346   .1580256     7.63   0.000     .8966031     1.51609
------------------------------------------------------------------------------
F test of absorbed indicators: F(45, 19923) = 2.614           Prob > F = 0.000

. 
. *insert a different value in a state-time cell: expect an error
. replace z=1 in 1
(1 real change made)

. cap drop aa*

. cap drop *imputed

. xtevent y, panelvar(state) t(t) policyvar(z) window(5) trend(-3, method(ols)) impute(instag, saveimp) savek(aa) r
> epeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

No proxy or instruments provided. Implementing OLS estimator

Policyvar is not constant within some (state, t) cells.
r(198);

end of do-file

r(198);

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. replace z=0 in 1
(1 real change made)

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. *xteventplot
. cap drop aa*

. xtevent y, panelvar(state) t(t) policyvar(z) window(5) trend(-3, method(gmm) saveoverlay) impute(stag) repeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =     19,784
Absorbed variable: state                        No. of categories =         46
                                                F(  31,  19707)   =     479.09
                                                Prob > F          =     0.0000
                                                R-squared         =     0.4867
                                                Adj R-squared     =     0.4847
                                                Root MSE          =     1.5317

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.1850382   .2876307    -0.64   0.520    -.7488186    .3787422
    _k_eq_m5 |  -.0455001   .1383685    -0.33   0.742    -.3167141    .2257139
    _k_eq_m4 |  -.0699293   .1788371    -0.39   0.696    -.4204652    .2806066
    _k_eq_m3 |  -.0000352   .1382154    -0.00   1.000     -.270949    .2708787
    _k_eq_m2 |  -.0829705   .1195222    -0.69   0.488    -.3172442    .1513031
    _k_eq_p0 |   1.314908   .1800171     7.30   0.000     .9620598    1.667757
    _k_eq_p1 |   1.302974   .2392026     5.45   0.000     .8341167    1.771831
    _k_eq_p2 |   1.046135   .2999155     3.49   0.000     .4582758    1.633995
    _k_eq_p3 |    .872851    .365824     2.39   0.017     .1558051    1.589897
    _k_eq_p4 |    .840055   .4350092     1.93   0.053    -.0125997     1.69271
    _k_eq_p5 |   .7678284   .5003356     1.53   0.125    -.2128715    1.748528
    _k_eq_p6 |   .6397549    .558933     1.14   0.252    -.4558009    1.735311
             |
           t |
          2  |   .1615822   .0685606     2.36   0.018     .0271977    .2959667
          3  |   .3470289   .0687261     5.05   0.000       .21232    .4817378
          4  |   .4711373   .0697734     6.75   0.000     .3343755    .6078991
          5  |   .6958334   .0693081    10.04   0.000     .5599836    .8316831
          6  |   .8774455   .0695813    12.61   0.000     .7410603    1.013831
          7  |   .9694107   .0699172    13.87   0.000      .832367    1.106454
          8  |   1.051634   .0686454    15.32   0.000     .9170836    1.186185
          9  |    1.38718   .0693366    20.01   0.000     1.251274    1.523086
         10  |   1.508209    .070324    21.45   0.000     1.370368    1.646051
         11  |   1.682576   .0692768    24.29   0.000     1.546788    1.818364
         12  |   1.909461   .0700563    27.26   0.000     1.772145    2.046777
         13  |   2.037896   .0711738    28.63   0.000     1.898389    2.177402
         14  |   2.248979   .0713762    31.51   0.000     2.109075    2.388882
         15  |   2.521183   .0713915    35.31   0.000      2.38125    2.661116
         16  |   2.594121   .0703865    36.86   0.000     2.456158    2.732085
         17  |   2.760309   .0709722    38.89   0.000     2.621198    2.899421
         18  |   2.989612   .0716881    41.70   0.000     2.849097    3.130127
         19  |    3.21758   .0715161    44.99   0.000     3.077402    3.357757
         20  |   3.325703   .0716604    46.41   0.000     3.185243    3.466164
             |
       _cons |   1.112045   .1184029     9.39   0.000     .8799651    1.344124
------------------------------------------------------------------------------
F test of absorbed indicators: F(45, 19707) = 2.214           Prob > F = 0.000

. xteventplot

. graph export test_xteventplot.png, replace
(file test_xteventplot.png written in PNG format)

. xteventplot, overlay(trend)

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. 
. ************* IV
. use "https://github.com/JMSLab/xtevent/blob/issue_59-allow-for-data-structures-that-cannot-be-xtseted/issues/59/s
> mall_repeated_cross_sectional_example31.dta?raw=true", clear

. xtset, clear //cannot xtset panelvar and timevar 

. *add missing values to policyvar 
. replace z=. if state==1 & t==12 
(19 real changes made, 19 to missing)

. 
. *default 
. xtevent y, panelvar(state) t(t) policyvar(z) window(5) proxy(x) repeatedcs 

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.
Policyvar has missing values within some (state, t) cells. These observations will be ignored.

Fixed-effects (within) IV regression            Number of obs     =      8,876
Group variable: state                           Number of groups  =         45

R-sq:                                           Obs per group:
     within  = 0.2176                                         min =        115
     between = 0.9839                                         avg =      197.2
     overall = 0.3639                                         max =        237

                                                Wald chi2(20)     =   23453.53
corr(u_i, Xb)  = -0.0723                        Prob > chi2       =     0.0000

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .1271011   .2200935     0.58   0.564    -.3042743    .5584765
    _k_eq_m6 |  -.4002496   .5754793    -0.70   0.487    -1.528168    .7276691
    _k_eq_m5 |    -.15713   .3821848    -0.41   0.681    -.9061985    .5919385
    _k_eq_m4 |  -.0571568   .3697957    -0.15   0.877    -.7819431    .6676295
    _k_eq_m3 |   .0988315   .2045295     0.48   0.629     -.302039    .4997021
    _k_eq_p0 |   1.280633   .4044152     3.17   0.002     .4879941    2.073273
    _k_eq_p1 |   1.361527   .4920868     2.77   0.006     .3970541    2.325999
    _k_eq_p2 |    1.24708   .5017032     2.49   0.013       .26376      2.2304
    _k_eq_p3 |   1.217038   .5555003     2.19   0.028     .1282771    2.305798
    _k_eq_p4 |   1.390935   .4913742     2.83   0.005     .4278596    2.354011
    _k_eq_p5 |   1.288122   .5912211     2.18   0.029     .1293496    2.446894
    _k_eq_p6 |   1.406596   .5633001     2.50   0.013     .3025478    2.510644
             |
           t |
          8  |   .1185182   .0900413     1.32   0.188    -.0579594    .2949958
          9  |   .4470316   .0816224     5.48   0.000     .2870548    .6070085
         10  |   .5845349   .0996282     5.87   0.000     .3892671    .7798026
         11  |   .7773235   .1180034     6.59   0.000      .546041    1.008606
         12  |   1.029273   .1508364     6.82   0.000     .7336387    1.324907
         13  |   1.152206   .1587178     7.26   0.000     .8411246    1.463287
         14  |   1.366898   .1592091     8.59   0.000     1.054854    1.678942
         15  |   1.648266   .1685526     9.78   0.000     1.317909    1.978623
             |
       _cons |   1.671235   .4766564     3.51   0.000      .737006    2.605465
-------------+----------------------------------------------------------------
     sigma_u |  .10687797
     sigma_e |  1.4764595
         rho |  .00521271   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(44,8811) =     0.87         Prob > F    = 0.7120
------------------------------------------------------------------------------
Instrumented:   x
Instruments:    _k_eq_m6 _k_eq_m5 _k_eq_m4 _k_eq_m3 _k_eq_p0 _k_eq_p1 _k_eq_p2
                _k_eq_p3 _k_eq_p4 _k_eq_p5 _k_eq_p6 8.t 9.t 10.t 11.t 12.t
                13.t 14.t 15.t _fd1z
------------------------------------------------------------------------------

. 
. *impute 
. xtevent y, panelvar(state) t(t) policyvar(z) window(5) impute(stag) proxy(x)  repeatedcs 

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.
Policyvar has missing values within some (state, t) cells. These observations will be ignored.

Fixed-effects (within) IV regression            Number of obs     =     18,790
Group variable: state                           Number of groups  =         46

R-sq:                                           Obs per group:
     within  = 0.3817                                         min =        117
     between = 0.9812                                         avg =      408.5
     overall = 0.4589                                         max =        486

                                                Wald chi2(30)     =   46751.12
corr(u_i, Xb)  = -0.1284                        Prob > chi2       =     0.0000

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .3074049   .1979138     1.55   0.120    -.0804991    .6953088
    _k_eq_m6 |   .2232916   .6331396     0.35   0.724    -1.017639    1.464223
    _k_eq_m5 |   .1718424   .4380839     0.39   0.695    -.6867862    1.030471
    _k_eq_m4 |   .1959053   .3824198     0.51   0.608    -.5536236    .9454343
    _k_eq_m3 |   .0385657   .1776535     0.22   0.828    -.3096287    .3867602
    _k_eq_p0 |   .9483263   .4077885     2.33   0.020     .1490755    1.747577
    _k_eq_p1 |   1.084804   .4284136     2.53   0.011     .2451292     1.92448
    _k_eq_p2 |   .8238491   .4845618     1.70   0.089    -.1258746    1.773573
    _k_eq_p3 |   .7064029   .5045243     1.40   0.161    -.2824467    1.695252
    _k_eq_p4 |   .9517509   .4714027     2.02   0.043     .0278186    1.875683
    _k_eq_p5 |   .8339865   .5711582     1.46   0.144    -.2854631    1.953436
    _k_eq_p6 |    .814589    .564586     1.44   0.149    -.2919792    1.921157
             |
           t |
          2  |   .2278271   .0820555     2.78   0.005     .0670013    .3886529
          3  |   .4323896   .0900224     4.80   0.000     .2559489    .6088303
          4  |    .606441   .1131372     5.36   0.000     .3846961    .8281858
          5  |   .8434111   .1196314     7.05   0.000     .6089378    1.077884
          6  |   .9824864   .0981123    10.01   0.000     .7901898    1.174783
          7  |    1.14598   .1347243     8.51   0.000      .881925    1.410035
          8  |   1.321604   .1875271     7.05   0.000     .9540582    1.689151
          9  |   1.640917   .1780906     9.21   0.000     1.291866    1.989968
         10  |   1.796141   .1987976     9.04   0.000     1.406505    2.185777
         11  |   2.012491   .2234076     9.01   0.000      1.57462    2.450362
         12  |   2.301697   .2609799     8.82   0.000     1.790186    2.813208
         13  |   2.441846   .2705252     9.03   0.000     1.911626    2.972065
         14  |   2.662323   .2738654     9.72   0.000     2.125557    3.199089
         15  |   2.955943   .2871624    10.29   0.000     2.393116    3.518771
         16  |   3.038298   .2928277    10.38   0.000     2.464367     3.61223
         17  |   3.275672   .3378462     9.70   0.000     2.613506    3.937838
         18  |   3.465486   .3125974    11.09   0.000     2.852807    4.078166
         19  |   3.777759   .3630954    10.40   0.000     3.066105    4.489413
             |
       _cons |   .0119642   .6423554     0.02   0.985    -1.247029    1.270958
-------------+----------------------------------------------------------------
     sigma_u |  .09860869
     sigma_e |  1.5594775
         rho |  .00398235   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(45,18714) =     1.11        Prob > F    = 0.2836
------------------------------------------------------------------------------
Instrumented:   x
Instruments:    _k_eq_m6 _k_eq_m5 _k_eq_m4 _k_eq_m3 _k_eq_p0 _k_eq_p1 _k_eq_p2
                _k_eq_p3 _k_eq_p4 _k_eq_p5 _k_eq_p6 2.t 3.t 4.t 5.t 6.t 7.t
                8.t 9.t 10.t 11.t 12.t 13.t 14.t 15.t 16.t 17.t 18.t 19.t
                _fd1__00000L
------------------------------------------------------------------------------

. 
. *trend 
. *trend not allowed in the IV setting
. 
. *nofe (then, it uses ivregress)
. xtevent y, panelvar(state) t(t) policyvar(z) window(5) impute(stag) proxy(x) repeatedcs nofe

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.
Policyvar has missing values within some (state, t) cells. These observations will be ignored.
note: 20.t identifies no observations in the sample


Instrumental variables (2SLS) regression

      Source |       SS       df       MS         Number of obs   =     18,790
-------------+------------------------------      F( 30, 18759)   =     503.85
       Model |  34856.9127    30  1161.89709      Prob > F        =     0.0000
    Residual |  46741.7253 18759    2.491696      R-squared       =     0.4272
-------------+------------------------------      Adj R-squared   =     0.4263
       Total |   81598.638 18789  4.34289414      Root MSE        =     1.5785

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .3254147   .2168231     1.50   0.133    -.0995782    .7504077
    _k_eq_m6 |    .366361   .8401205     0.44   0.663    -1.280351    2.013073
    _k_eq_m5 |   .2079764   .4816526     0.43   0.666    -.7361063    1.152059
    _k_eq_m4 |    .237045   .4191222     0.57   0.572    -.5844724    1.058562
    _k_eq_m3 |   .0551968   .1902049     0.29   0.772     -.317622    .4280157
    _k_eq_p0 |   .9155123   .4351388     2.10   0.035     .0626008    1.768424
    _k_eq_p1 |   1.050298   .4502461     2.33   0.020     .1677746    1.932821
    _k_eq_p2 |   .7982367   .5023252     1.59   0.112    -.1863661     1.78284
    _k_eq_p3 |   .6783872   .5368924     1.26   0.206    -.3739705    1.730745
    _k_eq_p4 |   .9313788   .4610128     2.02   0.043      .027752    1.835006
    _k_eq_p5 |   .8109833   .5793474     1.40   0.162    -.3245901    1.946557
    _k_eq_p6 |   .7994479   .5373361     1.49   0.137    -.2537796    1.852675
             |
           t |
          2  |   .2345875    .087815     2.67   0.008     .0624622    .4067128
          3  |   .4415966    .104338     4.23   0.000     .2370847    .6461085
          4  |    .624279   .1285368     4.86   0.000     .3723352    .8762227
          5  |   .8656259   .1398407     6.19   0.000     .5915255    1.139726
          6  |   .9987382   .1163873     8.58   0.000     .7706085    1.226868
          7  |   1.175051   .1683877     6.98   0.000     .8449954    1.505106
          8  |   1.351834   .2281205     5.93   0.000     .9046973    1.798971
          9  |   1.670347   .2163401     7.72   0.000     1.246301    2.094393
         10  |   1.825673   .2385745     7.65   0.000     1.358045      2.2933
         11  |    2.05106   .2712366     7.56   0.000     1.519412    2.582708
         12  |   2.341356   .3131423     7.48   0.000     1.727569    2.955144
         13  |   2.481834   .3228552     7.69   0.000     1.849008    3.114659
         14  |   2.703586   .3289623     8.22   0.000      2.05879    3.348382
         15  |   2.998101   .3421847     8.76   0.000     2.327388    3.668814
         16  |   3.077042   .3460328     8.89   0.000     2.398787    3.755298
         17  |   3.326104   .3961544     8.40   0.000     2.549606    4.102603
         18  |   3.509557   .3707483     9.47   0.000     2.782857    4.236258
         19  |   3.825489   .4178711     9.15   0.000     3.006424    4.644554
         20  |          0  (empty)
             |
       _cons |  -.1317791   .8498445    -0.16   0.877    -1.797551    1.533993
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   _k_eq_m6 _k_eq_m5 _k_eq_m4 _k_eq_m3 _k_eq_p0 _k_eq_p1
               _k_eq_p2 _k_eq_p3 _k_eq_p4 _k_eq_p5 _k_eq_p6 2.t 3.t 4.t 5.t
               6.t 7.t 8.t 9.t 10.t 11.t 12.t 13.t 14.t 15.t 16.t 17.t 18.t
               19.t _fd1__00000L

. 
. *reghdfe (then, it uses ivreghdfe)
. xtevent y, panelvar(state) t(t) policyvar(z) window(5) impute(stag) proxy(x) repeatedcs reghdfe

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.
Policyvar has missing values within some (state, t) cells. These observations will be ignored.
(MWFE estimator converged in 5 iterations)

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics consistent for homoskedasticity only

                                                      Number of obs =    18790
                                                      F( 12, 18714) =   120.55
                                                      Prob > F      =   0.0000
Total (centered) SS     =  47216.16597                Centered R2   =   0.0361
Total (uncentered) SS   =  47216.16597                Uncentered R2 =   0.0361
Residual SS             =  45511.88717                Root MSE      =    1.559

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .3074049   .1979138     1.55   0.120    -.0805242    .6953339
    _k_eq_m6 |   .2232916   .6331396     0.35   0.724     -1.01772    1.464303
    _k_eq_m5 |   .1718424   .4380839     0.39   0.695    -.6868417    1.030527
    _k_eq_m4 |   .1959053   .3824198     0.51   0.608    -.5536721    .9454827
    _k_eq_m3 |   .0385657   .1776535     0.22   0.828    -.3096512    .3867827
    _k_eq_p0 |   .9483263   .4077885     2.33   0.020     .1490238    1.747629
    _k_eq_p1 |   1.084804   .4284136     2.53   0.011     .2450749    1.924534
    _k_eq_p2 |   .8238491   .4845618     1.70   0.089    -.1259361    1.773634
    _k_eq_p3 |   .7064029   .5045243     1.40   0.161    -.2825106    1.695316
    _k_eq_p4 |   .9517509   .4714027     2.02   0.044     .0277588    1.875743
    _k_eq_p5 |   .8339865   .5711582     1.46   0.144    -.2855355    1.953508
    _k_eq_p6 |    .814589    .564586     1.44   0.149    -.2920508    1.921229
------------------------------------------------------------------------------
Underidentification test (Anderson canon. corr. LM statistic):           7.093
                                                   Chi-sq(1) P-val =    0.0077
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):                7.067
Stock-Yogo weak ID test critical values: 10% maximal IV size             16.38
                                         15% maximal IV size              8.96
                                         20% maximal IV size              6.66
                                         25% maximal IV size              5.53
Source: Stock-Yogo (2005).  Reproduced by permission.
------------------------------------------------------------------------------
Sargan statistic (overidentification test of all instruments):           0.000
                                                 (equation exactly identified)
------------------------------------------------------------------------------
Instrumented:         x
Included instruments: _k_eq_m6 _k_eq_m5 _k_eq_m4 _k_eq_m3 _k_eq_p0 _k_eq_p1
                      _k_eq_p2 _k_eq_p3 _k_eq_p4 _k_eq_p5 _k_eq_p6
Excluded instruments: _fd1__00000L
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
       state |        46           0          46     |
           t |        19           1          18     |
-----------------------------------------------------+

. 
. *xteventplot 
. xtevent y, panelvar(state) t(t) policyvar(z) window(5) impute(stag) proxy(x)  repeatedcs 

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.
Policyvar has missing values within some (state, t) cells. These observations will be ignored.

Fixed-effects (within) IV regression            Number of obs     =     18,790
Group variable: state                           Number of groups  =         46

R-sq:                                           Obs per group:
     within  = 0.3817                                         min =        117
     between = 0.9812                                         avg =      408.5
     overall = 0.4589                                         max =        486

                                                Wald chi2(30)     =   46751.12
corr(u_i, Xb)  = -0.1284                        Prob > chi2       =     0.0000

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .3074049   .1979138     1.55   0.120    -.0804991    .6953088
    _k_eq_m6 |   .2232916   .6331396     0.35   0.724    -1.017639    1.464223
    _k_eq_m5 |   .1718424   .4380839     0.39   0.695    -.6867862    1.030471
    _k_eq_m4 |   .1959053   .3824198     0.51   0.608    -.5536236    .9454343
    _k_eq_m3 |   .0385657   .1776535     0.22   0.828    -.3096287    .3867602
    _k_eq_p0 |   .9483263   .4077885     2.33   0.020     .1490755    1.747577
    _k_eq_p1 |   1.084804   .4284136     2.53   0.011     .2451292     1.92448
    _k_eq_p2 |   .8238491   .4845618     1.70   0.089    -.1258746    1.773573
    _k_eq_p3 |   .7064029   .5045243     1.40   0.161    -.2824467    1.695252
    _k_eq_p4 |   .9517509   .4714027     2.02   0.043     .0278186    1.875683
    _k_eq_p5 |   .8339865   .5711582     1.46   0.144    -.2854631    1.953436
    _k_eq_p6 |    .814589    .564586     1.44   0.149    -.2919792    1.921157
             |
           t |
          2  |   .2278271   .0820555     2.78   0.005     .0670013    .3886529
          3  |   .4323896   .0900224     4.80   0.000     .2559489    .6088303
          4  |    .606441   .1131372     5.36   0.000     .3846961    .8281858
          5  |   .8434111   .1196314     7.05   0.000     .6089378    1.077884
          6  |   .9824864   .0981123    10.01   0.000     .7901898    1.174783
          7  |    1.14598   .1347243     8.51   0.000      .881925    1.410035
          8  |   1.321604   .1875271     7.05   0.000     .9540582    1.689151
          9  |   1.640917   .1780906     9.21   0.000     1.291866    1.989968
         10  |   1.796141   .1987976     9.04   0.000     1.406505    2.185777
         11  |   2.012491   .2234076     9.01   0.000      1.57462    2.450362
         12  |   2.301697   .2609799     8.82   0.000     1.790186    2.813208
         13  |   2.441846   .2705252     9.03   0.000     1.911626    2.972065
         14  |   2.662323   .2738654     9.72   0.000     2.125557    3.199089
         15  |   2.955943   .2871624    10.29   0.000     2.393116    3.518771
         16  |   3.038298   .2928277    10.38   0.000     2.464367     3.61223
         17  |   3.275672   .3378462     9.70   0.000     2.613506    3.937838
         18  |   3.465486   .3125974    11.09   0.000     2.852807    4.078166
         19  |   3.777759   .3630954    10.40   0.000     3.066105    4.489413
             |
       _cons |   .0119642   .6423554     0.02   0.985    -1.247029    1.270958
-------------+----------------------------------------------------------------
     sigma_u |  .09860869
     sigma_e |  1.5594775
         rho |  .00398235   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(45,18714) =     1.11        Prob > F    = 0.2836
------------------------------------------------------------------------------
Instrumented:   x
Instruments:    _k_eq_m6 _k_eq_m5 _k_eq_m4 _k_eq_m3 _k_eq_p0 _k_eq_p1 _k_eq_p2
                _k_eq_p3 _k_eq_p4 _k_eq_p5 _k_eq_p6 2.t 3.t 4.t 5.t 6.t 7.t
                8.t 9.t 10.t 11.t 12.t 13.t 14.t 15.t 16.t 17.t 18.t 19.t
                _fd1__00000L
------------------------------------------------------------------------------

. xteventplot

. xteventplot, overlay(iv)

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. 
. ******************************  get_unit_time_effects (2nd approach) *****************
. 
. *load the small version of the repeated cross-sectional dataset example31
. use "https://github.com/JMSLab/xtevent/blob/issue_59-allow-for-data-structures-that-cannot-be-xtseted/issues/59/s
> mall_repeated_cross_sectional_example31.dta?raw=true", clear

. xtset, clear

. *add missing values to policyvar 
. replace z=. if state==1 & t==12 
(19 real changes made, 19 to missing)

. replace z=. in 1
(1 real change made, 1 to missing)

. 
. *move to my directory
. cd "$plots"
C:\Users\tino_\Dropbox\PC\Documents\xtevent\issues\59\implementation

. *erase in case those file already exists
. cap erase unit_time_effects.dta

. cap erase myfile.dta

. 
. *if saving is not specified, save it as unit_time_effects.dta in the current directory
. get_unit_time_effects y u eta, panelvar(state) timevar(t)

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file unit_time_effects.dta saved

. 
. *save it with a desired file name: if only a name, it will save it in the currect directory
. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("myfile")

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file myfile.dta saved

. *add dta extension
. cap erase myfile.dta

. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("myfile.dta")

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file myfile.dta saved

. *specify a directory 
. cap erase myfile.dta

. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta")

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta saved

. *don't use quotes
. cap erase myfile.dta

. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving($plots/myfile.dta)

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta saved

. 
. *try to save it again: expect an error
. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta")

File C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta already exists.
r(602);

end of do-file

r(602);

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. *avoid the error message: add the replace suboption
. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta", replace)

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta saved

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. *don't show the regression output
. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta", replace) nooutput
file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta saved

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. 
. *error if there is a variable named effects 
. gen _unittimeeffects=.
(20,000 missing values generated)

. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta", replace)

You have a variable named _unittimeeffects. This name is reserved for the variable that will contain the unit-time 
> effects.

Please rename or drop this variable before proceeding.
r(110);

end of do-file

r(110);

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. drop _unittimeeffects

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. *use clear option to load the effects file 
. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta", replace) clear

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta saved

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. 
. ************************ get_unit_time_effects + xtevent ***********************
. use "https://github.com/JMSLab/xtevent/blob/issue_59-allow-for-data-structures-that-cannot-be-xtseted/issues/59/s
> mall_repeated_cross_sectional_example31.dta?raw=true", clear

. xtset, clear

. *add missing values to policyvar 
. replace z=. if state==1 & t==12 
(19 real changes made, 19 to missing)

. replace z=. in 1
(1 real change made, 1 to missing)

. 
. get_unit_time_effects y u eta, panelvar(state) timevar(t) saving("$plots/myfile.dta", replace)

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: __000002                     No. of categories =        920
                                                F(   2,  19078)   =    1504.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5781
                                                Adj R-squared     =     0.5577
                                                Root MSE          =     1.4229

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           u |   -.001644   .0051352    -0.32   0.749    -.0117095    .0084214
         eta |   .2550361   .0046498    54.85   0.000     .2459221    .2641501
       _cons |   2.251179   .0100644   223.68   0.000     2.231452    2.270906
------------------------------------------------------------------------------
F test of absorbed indicators: F(919, 19078) = 18.418         Prob > F = 0.000
file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation/myfile.dta saved

. bysort state t (z): keep if _n==1
(19,080 observations deleted)

. keep state t z

. merge m:1 state t using "$plots\myfile.dta"

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                               920  (_merge==3)
    -----------------------------------------

. drop _merge

. cap drop aa*

. xtevent _unittimeeffects, panelvar(state) t(t) policyvar(z) window(5) savek(aa)

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =        405
Absorbed variable: state                        No. of categories =         45
                                                F(  20,    340)   =      78.60
                                                Prob > F          =     0.0000
                                                R-squared         =     0.8509
                                                Adj R-squared     =     0.8229
                                                Root MSE          =     0.3208

------------------------------------------------------------------------------
_unittimee~s |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.0845748   .1632699    -0.52   0.605    -.4057211    .2365715
    _k_eq_m5 |   .0648243   .1758963     0.37   0.713    -.2811577    .4108064
    _k_eq_m4 |   .1410126   .1704539     0.83   0.409    -.1942644    .4762895
    _k_eq_m3 |    .282527   .1658985     1.70   0.089    -.0437897    .6088438
    _k_eq_m2 |   .1543464   .1625443     0.95   0.343    -.1653727    .4740655
    _k_eq_p0 |   1.106618   .1625446     6.81   0.000      .786898    1.426337
    _k_eq_p1 |   1.216072   .1659009     7.33   0.000      .889751    1.542394
    _k_eq_p2 |   1.053911   .1634411     6.45   0.000     .7324284    1.375395
    _k_eq_p3 |   1.086842   .1711054     6.35   0.000     .7502839    1.423401
    _k_eq_p4 |    1.25626   .1803035     6.97   0.000     .9016094    1.610911
    _k_eq_p5 |   1.100301   .1915214     5.75   0.000     .7235846    1.477017
    _k_eq_p6 |    1.31958   .1777752     7.42   0.000      .969902    1.669257
             |
           t |
          8  |   .1699158   .0677728     2.51   0.013     .0366089    .3032226
          9  |   .4612106   .0680614     6.78   0.000     .3273361    .5950851
         10  |   .6066523    .068521     8.85   0.000     .4718738    .7414308
         11  |   .8105127   .0691834    11.72   0.000     .6744314     .946594
         12  |   1.081728    .070103    15.43   0.000      .943838    1.219618
         13  |   1.218078    .071268    17.09   0.000     1.077897     1.35826
         14  |   1.421628   .0726672    19.56   0.000     1.278694    1.564562
         15  |   1.690838   .0742898    22.76   0.000     1.544713    1.836964
             |
       _cons |  -.8580324   .1561859    -5.49   0.000    -1.165245   -.5508201
------------------------------------------------------------------------------
F test of absorbed indicators: F(44, 340) = 0.989             Prob > F = 0.496

. xteventplot

. graph export "$plots\get_utf_plus_xtevent.png", replace
(file C:/Users/tino_/Dropbox/PC/Documents/xtevent/issues/59/implementation\get_utf_plus_xtevent.png written in PNG 
> format)

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. 
. ******************* static
. *load the small version of the repeated cross-sectional dataset example31
. use "https://github.com/JMSLab/xtevent/blob/issue_59-allow-for-data-structures-that-cannot-be-xtseted/issues/59/s
> mall_repeated_cross_sectional_example31.dta?raw=true", clear

. xtset, clear

. ****repeated cross-sectional
. *ols
. xtevent y, panelvar(state) t(t) policyvar(z) impute(stag) static repeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

option static specified. Estimating static model

Plotting options ignored

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: state                        No. of categories =         46
                                                F(  20,  19934)   =     744.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.4866
                                                Adj R-squared     =     0.4849
                                                Root MSE          =     1.5356

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    __00000C |   2.023979   .0503121    40.23   0.000     1.925364    2.122595
             |
           t |
          2  |   .1676187   .0687028     2.44   0.015     .0329555    .3022819
          3  |   .3802633   .0687517     5.53   0.000     .2455042    .5150223
          4  |   .5078863   .0698064     7.28   0.000     .3710599    .6447127
          5  |   .7472692   .0692284    10.79   0.000     .6115757    .8829627
          6  |   .9364629   .0694271    13.49   0.000       .80038    1.072546
          7  |   1.057862   .0692967    15.27   0.000     .9220348    1.193689
          8  |   1.136833   .0679366    16.73   0.000     1.003672    1.269995
          9  |    1.46715   .0687868    21.33   0.000     1.332322    1.601977
         10  |   1.602228   .0696061    23.02   0.000     1.465794    1.738662
         11  |   1.763134   .0684208    25.77   0.000     1.629024    1.897245
         12  |   2.003192   .0692596    28.92   0.000     1.867437    2.138947
         13  |    2.14208   .0701629    30.53   0.000     2.004555    2.279605
         14  |   2.363576   .0703703    33.59   0.000     2.225645    2.501508
         15  |   2.632911   .0702403    37.48   0.000     2.495234    2.770588
         16  |   2.710091   .0691976    39.16   0.000     2.574458    2.845724
         17  |   2.871419   .0697862    41.15   0.000     2.734632    3.008205
         18  |   3.088504   .0705883    43.75   0.000     2.950145    3.226863
         19  |    3.33021   .0704581    47.27   0.000     3.192106    3.468314
         20  |   3.433454   .0706181    48.62   0.000     3.295037    3.571872
             |
       _cons |   .2586998   .0489467     5.29   0.000     .1627602    .3546395
------------------------------------------------------------------------------
F test of absorbed indicators: F(45, 19934) = 6.734           Prob > F = 0.000

. *IV
. xtevent y, panelvar(state) t(t) policyvar(z) impute(stag) proxy(x) static repeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

option static specified. Estimating static model

Plotting options ignored

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.

Fixed-effects (within) IV regression            Number of obs     =     19,005
Group variable: state                           Number of groups  =         46

R-sq:                                           Obs per group:
     within  = 0.4256                                         min =        249
     between = 0.9838                                         avg =      413.2
     overall = 0.4862                                         max =        486

                                                Wald chi2(20)     =   51510.98
corr(u_i, Xb)  = -0.0229                        Prob > chi2       =     0.0000

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .2382911   .0391435     6.09   0.000     .1615713    .3150108
    __00000M |   1.025171   .1676194     6.12   0.000     .6966435    1.353699
             |
           t |
          2  |   .2133027   .0677779     3.15   0.002     .0804605    .3461448
          3  |   .4141609   .0676509     6.12   0.000     .2815676    .5467542
          4  |   .5769161   .0693839     8.31   0.000     .4409263     .712906
          5  |   .8112636   .0687282    11.80   0.000     .6765588    .9459684
          6  |   .9627499   .0682077    14.11   0.000     .8290653    1.096435
          7  |   1.123886    .068788    16.34   0.000     .9890638    1.258708
          8  |   1.270686   .0700548    18.14   0.000     1.133381    1.407991
          9  |   1.595758   .0705044    22.63   0.000     1.457572    1.733944
         10  |   1.740506   .0718068    24.24   0.000     1.599768    1.881245
         11  |   1.935654   .0725515    26.68   0.000     1.793455    2.077852
         12  |    2.21381   .0759385    29.15   0.000     2.064973    2.362647
         13  |   2.351229   .0765389    30.72   0.000     2.201215    2.501242
         14  |   2.572205   .0766801    33.54   0.000     2.421914    2.722495
         15  |   2.857614    .077698    36.78   0.000     2.705329      3.0099
         16  |   2.942488   .0773749    38.03   0.000     2.790836     3.09414
         17  |   3.163412   .0829461    38.14   0.000      3.00084    3.325983
         18  |   3.343739   .0804814    41.55   0.000     3.185999     3.50148
         19  |   3.648547   .0859368    42.46   0.000     3.480114     3.81698
             |
       _cons |   .2399397   .0480963     4.99   0.000     .1456726    .3342067
-------------+----------------------------------------------------------------
     sigma_u |  .08896771
     sigma_e |    1.50587
         rho |  .00347838   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(45,18939) =     1.30        Prob > F    = 0.0837
------------------------------------------------------------------------------
Instrumented:   x
Instruments:    __00000M 2.t 3.t 4.t 5.t 6.t 7.t 8.t 9.t 10.t 11.t 12.t 13.t
                14.t 15.t 16.t 17.t 18.t 19.t _fd1__00000M
------------------------------------------------------------------------------

. **** panel
. *ols
. xtevent y, panelvar(state) t(t) policyvar(z) impute(stag) static repeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

option static specified. Estimating static model

Plotting options ignored

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: state                        No. of categories =         46
                                                F(  20,  19934)   =     744.21
                                                Prob > F          =     0.0000
                                                R-squared         =     0.4866
                                                Adj R-squared     =     0.4849
                                                Root MSE          =     1.5356

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    __00000C |   2.023979   .0503121    40.23   0.000     1.925364    2.122595
             |
           t |
          2  |   .1676187   .0687028     2.44   0.015     .0329555    .3022819
          3  |   .3802633   .0687517     5.53   0.000     .2455042    .5150223
          4  |   .5078863   .0698064     7.28   0.000     .3710599    .6447127
          5  |   .7472692   .0692284    10.79   0.000     .6115757    .8829627
          6  |   .9364629   .0694271    13.49   0.000       .80038    1.072546
          7  |   1.057862   .0692967    15.27   0.000     .9220348    1.193689
          8  |   1.136833   .0679366    16.73   0.000     1.003672    1.269995
          9  |    1.46715   .0687868    21.33   0.000     1.332322    1.601977
         10  |   1.602228   .0696061    23.02   0.000     1.465794    1.738662
         11  |   1.763134   .0684208    25.77   0.000     1.629024    1.897245
         12  |   2.003192   .0692596    28.92   0.000     1.867437    2.138947
         13  |    2.14208   .0701629    30.53   0.000     2.004555    2.279605
         14  |   2.363576   .0703703    33.59   0.000     2.225645    2.501508
         15  |   2.632911   .0702403    37.48   0.000     2.495234    2.770588
         16  |   2.710091   .0691976    39.16   0.000     2.574458    2.845724
         17  |   2.871419   .0697862    41.15   0.000     2.734632    3.008205
         18  |   3.088504   .0705883    43.75   0.000     2.950145    3.226863
         19  |    3.33021   .0704581    47.27   0.000     3.192106    3.468314
         20  |   3.433454   .0706181    48.62   0.000     3.295037    3.571872
             |
       _cons |   .2586998   .0489467     5.29   0.000     .1627602    .3546395
------------------------------------------------------------------------------
F test of absorbed indicators: F(45, 19934) = 6.734           Prob > F = 0.000

. *IV
. xtevent y, panelvar(state) t(t) policyvar(z) impute(stag) proxy(x) static repeatedcs

Option repeatedcs was specified. Using state as the panel variable and t as the time variable.

option static specified. Estimating static model

Plotting options ignored

Proxy for the confound specified. Implementing FHS estimator

proxyiv=select. Selecting lead order of differenced policy variable to use as instrument.

Lead 1 selected.

Fixed-effects (within) IV regression            Number of obs     =     19,005
Group variable: state                           Number of groups  =         46

R-sq:                                           Obs per group:
     within  = 0.4256                                         min =        249
     between = 0.9838                                         avg =      413.2
     overall = 0.4862                                         max =        486

                                                Wald chi2(20)     =   51510.98
corr(u_i, Xb)  = -0.0229                        Prob > chi2       =     0.0000

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .2382911   .0391435     6.09   0.000     .1615713    .3150108
    __00000M |   1.025171   .1676194     6.12   0.000     .6966435    1.353699
             |
           t |
          2  |   .2133027   .0677779     3.15   0.002     .0804605    .3461448
          3  |   .4141609   .0676509     6.12   0.000     .2815676    .5467542
          4  |   .5769161   .0693839     8.31   0.000     .4409263     .712906
          5  |   .8112636   .0687282    11.80   0.000     .6765588    .9459684
          6  |   .9627499   .0682077    14.11   0.000     .8290653    1.096435
          7  |   1.123886    .068788    16.34   0.000     .9890638    1.258708
          8  |   1.270686   .0700548    18.14   0.000     1.133381    1.407991
          9  |   1.595758   .0705044    22.63   0.000     1.457572    1.733944
         10  |   1.740506   .0718068    24.24   0.000     1.599768    1.881245
         11  |   1.935654   .0725515    26.68   0.000     1.793455    2.077852
         12  |    2.21381   .0759385    29.15   0.000     2.064973    2.362647
         13  |   2.351229   .0765389    30.72   0.000     2.201215    2.501242
         14  |   2.572205   .0766801    33.54   0.000     2.421914    2.722495
         15  |   2.857614    .077698    36.78   0.000     2.705329      3.0099
         16  |   2.942488   .0773749    38.03   0.000     2.790836     3.09414
         17  |   3.163412   .0829461    38.14   0.000      3.00084    3.325983
         18  |   3.343739   .0804814    41.55   0.000     3.185999     3.50148
         19  |   3.648547   .0859368    42.46   0.000     3.480114     3.81698
             |
       _cons |   .2399397   .0480963     4.99   0.000     .1456726    .3342067
-------------+----------------------------------------------------------------
     sigma_u |  .08896771
     sigma_e |    1.50587
         rho |  .00347838   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(45,18939) =     1.30        Prob > F    = 0.0837
------------------------------------------------------------------------------
Instrumented:   x
Instruments:    __00000M 2.t 3.t 4.t 5.t 6.t 7.t 8.t 9.t 10.t 11.t 12.t 13.t
                14.t 15.t 16.t 17.t 18.t 19.t _fd1__00000M
------------------------------------------------------------------------------

. 
end of do-file

. do "C:\Users\tino_\AppData\Local\Temp\STD37f0_000000.tmp"

. ******************* verify that estimation for panel datasets keep working 
. 
. use "https://github.com/JMSLab/xtevent/blob/main/test/example31.dta?raw=true", clear

. xtevent y, panelvar(i) t(t) policyvar(z) window(5) impute(stag) trend(-3)

No proxy or instruments provided. Implementing OLS estimator

Linear regression, absorbing indicators         Number of obs     =     20,000
Absorbed variable: i                            No. of categories =      1,000
                                                F(  31,  18969)   =    1018.66
                                                Prob > F          =     0.0000
                                                R-squared         =     0.7718
                                                Adj R-squared     =     0.7594
                                                Root MSE          =     1.0760

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    _k_eq_m6 |  -.2467548   .1849053    -1.33   0.182    -.6091857    .1156762
    _k_eq_m5 |   .0017259   .0881571     0.02   0.984    -.1710698    .1745217
    _k_eq_m4 |  -.0154363   .1174935    -0.13   0.895     -.245734    .2148615
    _k_eq_m3 |   .0001345   .0881066     0.00   0.999    -.1725623    .1728314
    _k_eq_m2 |  -.0396648   .0749674    -0.53   0.597    -.1866076     .107278
    _k_eq_p0 |   1.293391   .1140981    11.34   0.000     1.069748    1.517033
    _k_eq_p1 |   1.114729   .1508017     7.39   0.000     .8191439    1.410314
    _k_eq_p2 |   1.121351   .1904389     5.89   0.000      .748074    1.494628
    _k_eq_p3 |   1.037553   .2319221     4.47   0.000     .5829647    1.492141
    _k_eq_p4 |   .9064041   .2743545     3.30   0.001     .3686449    1.444163
    _k_eq_p5 |   .9687918   .3171039     3.06   0.002       .34724    1.590344
    _k_eq_p6 |   .7856907   .3541065     2.22   0.027     .0916103    1.479771
             |
           t |
          2  |   .1221644   .0481295     2.54   0.011     .0278262    .2165026
          3  |    .294043   .0481579     6.11   0.000     .1996491    .3884368
          4  |   .4781116   .0481959     9.92   0.000     .3836433    .5725799
          5  |   .6743587   .0482472    13.98   0.000       .57979    .7689275
          6  |   .8198709   .0483149    16.97   0.000     .7251695    .9145723
          7  |   .9654066   .0483876    19.95   0.000     .8705626    1.060251
          8  |   1.220668   .0484815    25.18   0.000      1.12564    1.315696
          9  |   1.369915    .048591    28.19   0.000     1.274672    1.465158
         10  |   1.580138   .0487026    32.44   0.000     1.484676    1.675599
         11  |   1.688944   .0488182    34.60   0.000     1.593256    1.784632
         12  |   1.831907   .0489704    37.41   0.000      1.73592    1.927893
         13  |   2.032309   .0491323    41.36   0.000     1.936006    2.128613
         14  |   2.164121    .049286    43.91   0.000     2.067516    2.260726
         15  |   2.391336   .0494831    48.33   0.000     2.294345    2.488327
         16  |   2.578597   .0496266    51.96   0.000     2.481324    2.675869
         17  |   2.779282   .0497695    55.84   0.000      2.68173    2.876835
         18  |   2.938233    .049905    58.88   0.000     2.840415    3.036051
         19  |   3.137937   .0500507    62.70   0.000     3.039833    3.236041
         20  |   3.315853   .0501911    66.06   0.000     3.217474    3.414232
             |
       _cons |   1.125864   .0757572    14.86   0.000     .9773737    1.274355
------------------------------------------------------------------------------
F test of absorbed indicators: F(999, 18969) = 22.378         Prob > F = 0.000

. xteventplot

. 
. cap log close
